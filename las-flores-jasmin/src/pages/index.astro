---
import NavBar from '../components/NavBar.astro';
import '../styles/global.css';
import { useState, useEffect } from 'react';
import { jsx } from 'astro/jsx-runtime';

let posts = [];

try {
  const res = await fetch(
    `https://graph.facebook.com/v23.0/17841457779337649/media?fields=id,media_type,media_url,permalink,caption,timestamp&access_token=${import.meta.env.IG_ACCESS_TOKEN}&limit=12`
  );
  if (res.ok) {
    const json = await res.json();
    posts = json.data || [];
  }
} catch (err) {
  console.error('Instagram fetch failed:', err);
}
---


<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Las Flores Jasmin</title>
    <meta name="description" content="Fresh floral beauty from Las Flores Jasmin" />
    <link rel="icon" href="/favicon.ico" />
  </head>
  <body class="font-sans bg-white text-gray-800">
    <NavBar />

    <p class="text-center text-green-600 mt-6 text-sm">
      ✅ Posts loaded: {posts.length}
    </p>

    <!-- Slideshow (Top 5) -->
   <div client:load>
  <script type="module">
    let current = 0;
    const INTERVAL = 5000;

    function updateSlides() {
      const slides = document.querySelectorAll('.insta-slide');
      slides.forEach((el, i) => {
        const offset = i - current;
        el.style.transform = `translateX(${offset * 100}%)`;
        el.style.zIndex = -Math.abs(offset);
        el.classList.toggle('scale-100', offset === 0);
        el.classList.toggle('scale-75', offset !== 0);
        el.classList.toggle('opacity-100', Math.abs(offset) <= 1);
        el.classList.toggle('opacity-0', Math.abs(offset) > 1);
      });
    }

    function nextSlide() {
      const slides = document.querySelectorAll('.insta-slide');
      current = (current + 1) % slides.length;
      updateSlides();
    }

    function prevSlide() {
      const slides = document.querySelectorAll('.insta-slide');
      current = (current - 1 + slides.length) % slides.length;
      updateSlides();
    }

    let interval = setInterval(nextSlide, INTERVAL);

    window.addEventListener('load', () => {
      updateSlides();

      document.getElementById('next-btn').addEventListener('click', () => {
        nextSlide();
        clearInterval(interval);
        interval = setInterval(nextSlide, INTERVAL);
      });

      document.getElementById('prev-btn').addEventListener('click', () => {
        prevSlide();
        clearInterval(interval);
        interval = setInterval(nextSlide, INTERVAL);
      });
    });
  </script>

  <div class="relative w-full max-w-5xl mx-auto py-8">
    <!-- Arrows -->
    <button id="prev-btn" class="absolute left-0 top-1/2 -translate-y-1/2 bg-white p-2 rounded-full shadow z-20 hover:bg-gray-100">
      ←
    </button>
    <button id="next-btn" class="absolute right-0 top-1/2 -translate-y-1/2 bg-white p-2 rounded-full shadow z-20 hover:bg-gray-100">
      →
    </button>

    <!-- Slides -->
    <div class="overflow-hidden relative h-96">
      <div class="flex transition-transform duration-500 ease-in-out">
        {posts.slice(0, 5).map((post, i) => (
          <a
            href={post.permalink}
            target="_blank"
            rel="noopener noreferrer"
            class="insta-slide absolute top-0 left-0 w-full transition-all duration-700 ease-in-out scale-75 opacity-0"
          >
            {post.media_type === 'IMAGE' || post.media_type === 'CAROUSEL_ALBUM' ? (
              <img src={post.media_url} alt={post.caption ?? 'Instagram post'} class="w-full h-96 object-cover rounded-xl shadow" />
            ) : post.media_type === 'VIDEO' ? (
              <video src={post.media_url} controls muted class="w-full h-96 object-cover rounded-xl shadow" />
            ) : null}
          </a>
        ))}
      </div>
    </div>
  </div>
</div>



    <!-- Bouquet-style Cards (Remaining) -->
    <section class="w-full max-w-6xl mx-auto mt-12 px-4 grid gap-6 grid-cols-1 sm:grid-cols-2 md:grid-cols-3">
      {posts.slice(5).map(post => (
        <a
          href={post.permalink}
          target="_blank"
          rel="noopener noreferrer"
          class="block bg-pink-50 border border-pink-200 rounded-xl overflow-hidden shadow-sm hover:shadow-md transition"
        >
          {post.media_type === 'IMAGE' || post.media_type === 'CAROUSEL_ALBUM' ? (
            <img
              src={post.media_url}
              alt={post.caption ?? 'Instagram post'}
              class="w-full h-64 object-cover"
            />
          ) : post.media_type === 'VIDEO' ? (
            <video
              class="w-full h-64 object-cover"
              src={post.media_url}
              controls
              muted
              preload="metadata"
            />
          ) : null}
          <div class="p-4">
            <p class="text-sm text-gray-600 line-clamp-3">{post.caption}</p>
          </div>
        </a>
      ))}
    </section>
  </body>
</html>
